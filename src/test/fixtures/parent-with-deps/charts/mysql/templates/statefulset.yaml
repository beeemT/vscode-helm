apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-mysql-secret
type: Opaque
data:
  # In subchart templates, .Values refers to the subchart's values
  # which are merged from: subchart defaults + parent values under alias key + global
  root-password: {{ .Values.auth.rootPassword | b64enc }}
  database: {{ .Values.auth.database | b64enc }}
  username: {{ .Values.auth.username | default "mysql" | b64enc }}
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ .Release.Name }}-mysql
spec:
  template:
    spec:
      containers:
        - name: mysql
          image: mysql:8.0
          resources:
            limits:
              memory: {{ .Values.primary.resources.limits.memory }}
              cpu: {{ .Values.primary.resources.limits.cpu | default "500m" }}
          env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-mysql-secret
                  key: root-password
            - name: GLOBAL_ENV
              value: {{ .Values.global.environment | default "development" }}
            - name: GLOBAL_REGION
              value: {{ .Values.global.region | default "local" }}
